## This file contains a record of how some of the test data was
## generated. The final build products are committed to the repository
## as well to make sure that the test data is identical. You do not
## need to use this makefile unless you're extending mbed TLS's tests.

## Many data files were generated prior to the existence of this
## makefile, so the method of their generation was not recorded.

## Note that in addition to depending on the version of the data
## generation tool, many of the build outputs are randomized, so
## running this makefile twice would not produce the same results.

## Tools
OPENSSL ?= openssl
FAKETIME ?= faketime

TOP_DIR = $(shell git rev-parse --show-toplevel)
MBEDTLS_CERT_WRITE ?= $(TOP_DIR)/programs/x509/cert_write
MBEDTLS_CERT_REQ ?= $(TOP_DIR)/programs/x509/cert_req


## Build the generated test data. Note that since the final outputs
## are committed to the repository, this target should do nothing on a
## fresh checkout. Furthermore, since the generation is randomized,
## re-running the same targets may result in differing files. The goal
## of this makefile is primarily to serve as a record of how the
## targets were generated in the first place.
default: all_final

all_intermediate := # temporary files
all_final := # files used by tests
all_reserved_files := # files that should not be removed with `make neat`.
all_meta_targets:= list_% # targets that do not generate files


################################################################
#### Meta targets and variables
################################################################


all_final: $(all_final)
all: $(all_intermediate) $(all_final)

all_commited_files:= $(shell git ls-files)
# all_targets=$(shell make -qp | awk -F':' '/^[a-zA-Z0-9][^$$#\/\t=]*:([^=]|$$)/ {split($$1,A,/ /);for(i in A)print A[i]}')
all_reserved_files += .gitignore $(MAKEFILE_LIST)

define _get_all_targets
$(shell LC_ALL=C $(MAKE) -pRrq -f $(firstword $(MAKEFILE_LIST)) : 2>/dev/null | awk -v RS= -F: '/(^|\n)# Files(\n|$$)/,/(^|\n)# Finished Make data base/ {if ($$1 !~ "^[#.]") {print $$1}}' | sort | grep -E -v -e '^[^[:alnum:]]' -e '^$@$$')

endef
ifeq ($(filter pq%,$(MAKEFLAGS)),)
all_targets:=$(shell makefiles/list_targets.sh $(firstword $(MAKEFILE_LIST)))
endif
# These files should not be committed to the repository.
list_intermediate:
# These files are not generated by makefiles and should not be removed by
# `make neat`.
list_reserved_files:
# These files should be committed to the repository so that the test data is
# available upon checkout without running a randomized process depending on
# third-party tools.
# Note:
list_final:
# list all targets in makefiles
# set(all_final) + set(all_parse_input) - set(all_targets) = set()
list_targets:
# set(all_final) + set(all_parse_input) + set(all_config_files) =
# set(all_commited_files)
list_commited_files:

# Ruler for show all_* variables.
list_%:
	@printf '%s\n' $(all_$(@:list_%=%)) | sort

# set(all_targets) - (set(all_final) + set(all_parse_input)) = set(meta_targets)
list_meta_targets:
	@printf '%s\n' $(filter $(all_meta_targets),$(all_targets)) | sort


## Remove intermediate files
clean:
	rm -f $(all_intermediate)

## Remove all build products, even the ones that are committed
neat: clean
	rm -f $(all_final)

.PHONY: clean neat
.PHONY: default all_final all
.PHONY: list_%
.SECONDARY: $(all_intermediate)
